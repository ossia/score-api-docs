<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.9.8"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>score: Plug-ins, factories and interfaces</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="doxy-boot.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="http://ossia.io">score </a>
                </div>
                <ul class="nav navbar-nav">
                  <li class="active"><a href="index.html">Home</a></li>
                  <li><a href="classes.html">Classes</a></li>
                  <li><a href="namespaces.html">Namespaces</a></li>
                  <li><a href="files.html">Files</a></li>
                </ul>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_plugins_factories_and_interfaces.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Plug-ins, factories and interfaces</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Due to the plug-in architecture of the software, a system to load classes has to be devised.</p>
<p>It extends Qt's plug-in system with factory registration, and works in tandem with Contexts.</p>
<p>The core plug-ins are in the folder base/plugins.</p>
<p>Other plug-ins are available on the github page : <a href="https://github.com/ossia/">https://github.com/ossia/</a></p>
<p>For instance:</p>
<ul>
<li>score-addon-audio provides audio sequencer features</li>
<li>score-addon-remotecontrol exposes the object tree through a WebSockets protocol</li>
<li>etc...</li>
</ul>
<h1><a class="anchor" id="Anatomy"></a>
Anatomy of a plug-in</h1>
<p>A plug-in generally has the following file structure:</p>
<div class="fragment"><div class="line">plugin-name/</div>
<div class="line">           /CMakeLists.txt</div>
<div class="line">           /the_plugin.hpp</div>
<div class="line">           /the_plugin.cpp</div>
<div class="line">           /ThePlugin/{code of the plug-in}</div>
</div><!-- fragment --><p>For score to detect new plug-ins, they have to be put in the <code>base/addons/</code> folder, and CMake has to be re-run.</p>
<p>The root class of the plug-in is part of the Qt Plugin System (see its documentation). It provides multiple initialization functions, going from the most global to the most specific :</p>
<ul>
<li>Constructor</li>
<li>ApplicationPlugin</li>
<li>Lists of factories</li>
<li>Factories</li>
<li>Commands</li>
</ul>
<p>See for instance <a class="el" href="classscore__plugin__scenario.html">score_plugin_scenario</a> for the most complex case, or <a class="el" href="classscore__plugin__js.html">score_plugin_js</a> for a simple case that only adds a process.</p>
<p>The classes are then registered in the ApplicationContext; they will be accessible from the whole software. Classes are strongly-typed as far as possible, and categorized by their interfaces.</p>
<p>Each interface will be registered in the relevant list of interfaces; else there is no point in using a plug-in system.</p>
<p>For instance, let's take the UI panels, such as history, device explorer, etc.</p>
<ul>
<li>The application registers a list of factories: <a class="el" href="classscore_1_1_panel_delegate_factory_list.html" title="All the panels are registered in this interface list.">score::PanelDelegateFactoryList</a>.</li>
<li>For each kind of panel, a factory will be registered in this list.</li>
<li>When creating the actual panels, <a class="el" href="classscore_1_1_panel_delegate_factory_list.html" title="All the panels are registered in this interface list.">score::PanelDelegateFactoryList</a> is iterated:</li>
<li>Each factory's <a class="el" href="classscore_1_1_panel_delegate_factory.html#abb1a53923da779a4398099b3227fb1fd" title="Create an instance of a PanelDelegate. Will only be called once.">score::PanelDelegateFactory::make</a> function is called and the panel is shown.</li>
</ul>
<p>When loading a new document, many classes will depend on plug-in interfaces for loading. For instance, when loading a <a class="el" href="class_process_1_1_process_model.html" title="The Process class.">Process::ProcessModel</a>, one has to find the right factory to use to create the correct instance of the <a class="el" href="class_process_1_1_process_model.html" title="The Process class.">Process::ProcessModel</a>.</p>
<p>This is achieved by adding an unique identifier to each plug-in class, through the macros SCORE_INTERFACE and SCORE_CONCRETE. Such identifiers can be generated through the <code>uuidgen</code> command on Linux, macOS and Windows.</p>
<h1><a class="anchor" id="NewClass"></a>
Adding a new component</h1>
<p>Adding a new class that matches an existing interface, for instance for providing a new settings panel, is straightforward:</p>
<ul>
<li>Inherit from the base classes required for this component. The classes to reimplement to provide a custom settings panel are <a class="el" href="classscore_1_1_settings_delegate_model.html">score::SettingsDelegateModel</a>, <a class="el" href="classscore_1_1_settings_delegate_presenter.html">score::SettingsDelegatePresenter</a>, <a class="el" href="classscore_1_1_settings_delegate_view.html">score::SettingsDelegateView</a>.</li>
<li>Inherit from the corresponding factory : in this case <a class="el" href="classscore_1_1_settings_delegate_factory.html" title="The SettingsDelegateFactory class.">score::SettingsDelegateFactory</a>. In many cases, the factories are very simple code that only does <code>new MyImplementationOfTheClass</code>. Hence, to simplify the user code and minimize the amount of code, template overloads and macros are provided. In the case of the settings, one could either :<ul>
<li>Reimplement <a class="el" href="classscore_1_1_settings_delegate_factory.html" title="The SettingsDelegateFactory class.">score::SettingsDelegateFactory</a> entirely</li>
<li>Extend SettingsDelegateFactory_T&lt;MyModel, MyPresenter, MyView&gt; and add SCORE_CONCRETE(a-generated-uuid) : <div class="fragment"><div class="line">        <span class="keyword">class </span>MyFactory : <span class="keyword">public</span> <a class="code hl_class" href="classscore_1_1_settings_delegate_factory___t.html">score::SettingsDelegateFactory_T</a>&lt;MyModel,</div>
<div class="line">MyPresenter, MyView&gt; {</div>
<div class="line">            SCORE_CONCRETE(<span class="stringliteral">&quot;c42ff76c-85bd-42c2-9879-cdc660f968f3&quot;</span>)</div>
<div class="line">        };</div>
<div class="ttc" id="aclassscore_1_1_settings_delegate_factory___t_html"><div class="ttname"><a href="classscore_1_1_settings_delegate_factory___t.html">score::SettingsDelegateFactory_T</a></div><div class="ttdef"><b>Definition</b> SettingsDelegateFactory.hpp:46</div></div>
</div><!-- fragment --></li>
<li>Call the macro SCORE_DECLARE_SETTINGS_FACTORY : <div class="fragment"><div class="line">          SCORE_DECLARE_SETTINGS_FACTORY(MyFactory, MyModel, MyPresenter,</div>
<div class="line">MyView, <span class="stringliteral">&quot;c42ff76c-85bd-42c2-9879-cdc660f968f3&quot;</span>)</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Add them to the list of factories in the root plug-in file. That is, in the <code>my_plugin</code> file which extends <code><a class="el" href="classscore_1_1_factory_interface___qt_interface.html">score::FactoryInterface_QtInterface</a></code>, add a line such as <code>FW&lt;<a class="el" href="classscore_1_1_settings_delegate_factory.html" title="The SettingsDelegateFactory class.">score::SettingsDelegateFactory</a>, MyFactory&gt;</code>. score will then instantiate and register <code>MyFactory</code> automatically on startup.</li>
</ul>
<h1><a class="anchor" id="NewInterface"></a>
Declaring a new interface</h1>
<p>Declaring a new interface is when you want to provide a new kind of behaviour that can itself be extended further through other plug-ins. For instance, the audio addon provides Faust and LV2 support, through an interface that allows further plug-ins to add new kind of audio effects, such as VST.</p>
<ul>
<li>The first thing to do is to isolate the class or group of classes that constitute the feature. These should be standard abstract classes with virtual methods for the functions you want to override. We will take the example of the protocol implementation and use <a class="el" href="class_device_1_1_device_interface.html">Device::DeviceInterface</a> as a reference.</li>
<li><p class="startli">Then, create the abstract factory from which concrete factories will inherit. For instance, <a class="el" href="class_device_1_1_protocol_factory.html">Device::ProtocolFactory</a>.</p>
<p class="startli">The abstract factory should:</p><ul>
<li>inherit from <code>score::Interface&lt;TheFactory&gt;</code></li>
<li>have the SCORE_INTERFACE macro.</li>
<li>have relevant virtual functions. For instance, Device::ProtocolFactory::makeDevice. <pre class="fragment">These functions can be pure virtual, or provide a default dummy
</pre> implementation.</li>
</ul>
</li>
<li>Then, create the factory list class. Most of the time, the only thing to do is inheriting from <code><a class="el" href="classscore_1_1_interface_list.html" title="InterfaceList Default implementation of InterfaceListBase.">score::InterfaceList</a>&lt;TheFactory&gt;</code>.</li>
<li>Like we saw in the previous section, helper templates and macros should be provided.</li>
<li>Finally, in the root plug-in class, register the factory list in the <code>factoryFamilies()</code> function.</li>
</ul>
<p>Now, user code can look for registered interfaces by doing :</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span>&amp; ctx = score::AppContext();</div>
<div class="line"><span class="keyword">auto</span>&amp; list = ctx.interfaces&lt;TheFactoryList&gt;();</div>
</div><!-- fragment --><p>This list can be iterated; it is also possible to look for a concrete class by type or UUID:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span>(<span class="keyword">auto</span> myFactory = list.get&lt;MyConcreteFactory&gt;()) { ... }</div>
<div class="line"><span class="keywordflow">if</span>(<span class="keyword">auto</span> loadedFactory = list.get(anUuid)) {</div>
<div class="line">    loadedFactory-&gt;makeDevice(...);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; factory : list) {</div>
<div class="line">  <span class="keywordflow">if</span>(factory.matches(<span class="stringliteral">&quot;something&quot;</span>)) {</div>
<div class="line">    factory.createStuff();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="AddonManager"></a>
Add-on manager</h1>
<p>score provides a tentative add-on manager.</p>
<p>Its implementation is in score-plugin-pluginsettings. Add-ons are listed in a central repository :</p>
<p><a href="https://github.com/ossia/score-addons/blob/master/addons.json">https://github.com/ossia/score-addons/blob/master/addons.json</a></p>
<p>Each addon provides a JSON description file with the following keys :</p>
<ul>
<li>One key per plug-in architecture. The possible names are :<ul>
<li>src</li>
<li>windows-x86</li>
<li>windows-amd64</li>
<li>windows-arm64</li>
<li>darwin-amd64</li>
<li>darwin-arm64</li>
<li>linux-amd64</li>
<li>linux-arm</li>
<li>linux-arm64</li>
</ul>
</li>
<li>Currently score only supports <code>src</code> which means that the plug-in will be built from source.</li>
</ul>
<p>The value should be a link to a zipped addon package for the relevant architecture.</p>
<ul>
<li><a class="el" href="struct_metadata.html" title="Static metadata implementation.">Metadata</a> keys:<ul>
<li>name</li>
<li>version</li>
<li>short: a short description text</li>
<li>long: a long description text, can contain HTML</li>
<li>small: a miniature image (64x64)</li>
<li>large: a large image (512x512)</li>
<li>key: a unique identifier for the add-on</li>
</ul>
</li>
</ul>
<p>An add-on package should have the following layout :</p>
<div class="fragment"><div class="line">TheAddon.zip/AddonName/localaddon.json</div>
<div class="line">TheAddon.zip/AddonName/TheAddon-arch.{so,dylib,dll}</div>
</div><!-- fragment --><p><code>localaddon.json</code> has the same metadata keys than before. Instead of an url, the architecture key has the filename as value, e.g. "TheAddon-amd64.dylib".</p>
<p>Add-ons are searched for in <code>$DOCUMENTS/score/addons</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
